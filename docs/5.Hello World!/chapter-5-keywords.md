# chapter-5-keywords

## ğŸ“Œ `ecall` ëª…ë ¹ì–´

âœ… **ê°œë…**

- `ecall`ì€ environment call â†’ ìƒìœ„ í™˜ê²½ì—ê²Œ í˜¸ì¶œ
- ìƒìœ„ ê¶Œí•œ ìˆ˜ì¤€ì—ê²Œ ìš”ì²­í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ëª…ë ¹ì–´
- ì‚¬ìš©ì ëª¨ë“œ â†’ ì»¤ë„ || ì»¤ë„ â†’ íŒì›¨ì–´

âœ…Â ì‚¬ìš© ì˜ˆì‹œ

- ì‚¬ìš©ì ëª¨ë“œ â†’ OS ì»¤ë„ : ì‚¬ìš©ì í”„ë¡œê·¸ë¨ì´ ì‹œìŠ¤í…œì½œì„ ìš”ì²­í•  ë•Œ
- OS ì»¤ë„ â†’ íŒì›¨ì–´ : ì»¤ë„ì´ SBI í˜¸ì¶œì„ í•  ë•Œ

ğŸ¤–Â ì˜ˆì‹œ: SBI í˜¸ì¶œ (OS â†’ OpenSBI)

- SBI í˜¸ì¶œì„ ë°›ìœ¼ë©´ OpenSBIsms M-modeì—ì„œ ì‹¤í–‰ë¨ â†’ ê·¸ëŸ¬ê³  ecallì— ì‘ë‹µ

```c
register int a7 asm("a7") = 0; // SBI call ë²ˆí˜¸
__asm__ volatile ("ecall");
```

## ğŸ“ŒÂ `sbi_call` ì„¤ëª…

âœ…Â SBI í˜¸ì¶œ í•¨ìˆ˜ ì •ì˜

- ì¦‰, ì´ í•¨ìˆ˜ëŠ” íŠ¹ì • ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ì§€ ì•Šê³  SBI í˜¸ì¶œ ê·œì•½ì— ë§ê²Œ ì¸ìë¥¼ ì„¤ì •í•˜ê³  `ecall`ì„ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜

ğŸ¤–Â `sbi_call` ì½”ë“œ

```c
struct sbiret sbi_call(long arg0, long arg1, long arg2, long arg3,
                       long arg4, long arg5, long fid, long eid) {
    register long a0 __asm__("a0") = arg0;
    register long a1 __asm__("a1") = arg1;
    register long a2 __asm__("a2") = arg2;
    register long a3 __asm__("a3") = arg3;
    register long a4 __asm__("a4") = arg4;
    register long a5 __asm__("a5") = arg5;
    register long a6 __asm__("a6") = fid;
    register long a7 __asm__("a7") = eid;

    __asm__ __volatile__("ecall"
                         : "=r"(a0), "=r"(a1)
                         : "r"(a0), "r"(a1), "r"(a2), "r"(a3), "r"(a4), "r"(a5),
                           "r"(a6), "r"(a7)
                         : "memory");
    return (struct sbiret){.error = a0, .value = a1};
}
```

ğŸ‘‰Â `fid`, `eid`

- `eid` : Extension ID : SBI ì•ˆì—ì„œ ì–´ë–¤ ê·¸ë£¹(extension)ì„ ì‚¬ìš©í• ì§€ ê²°ì •í•˜ëŠ” ë²ˆí˜¸
- `fid` : Fucntion ID : í•´ë‹¹ extension ì•ˆì—ì„œ ì–´ë–¤ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í• ì§€ ê²°ì •í•˜ëŠ” ë²ˆí˜¸

ğŸ‘‰Â `register long a0 __asm__("a0") = arg0;`

- C ë³€ìˆ˜ `arg0`ì„ RISC-Vì˜ `a0` ë ˆì§€ìŠ¤í„°ì— ì§ì ‘ ì—°ê²°í•˜ëŠ” ì½”ë“œ
- ì´ëŸ° ë°©ì‹ìœ¼ë¡œ `a0` ë ˆì§€ìŠ¤í„° ~ `a7` ë ˆì§€ìŠ¤í„°ì— ë³€ìˆ˜ ì—°ê²°

ğŸ‘‰Â `a0` ë ˆì§€ìŠ¤í„°ë¶€í„° `a7` ë ˆì§€ìŠ¤í„°ì˜ ì˜ë¯¸ëŠ” `SBI í˜¸ì¶œ ê·œì•½`ì— ë”°ë¥¸ ê²ƒ

- `a0 ~ a5` : í•¨ìˆ˜ ì¸ì
- `a6` : í•¨ìˆ˜ ë²ˆí˜¸ (Function ID)
- `a7` : í™•ì¥ ID (Extension ID)

ğŸ‘‰Â `__asm__ __volatile__("ecall" ...)`

- `ecall` ëª…ë ¹ìœ¼ë¡œ ìƒìœ„ ê¶Œí•œì— ì‹œìŠ¤í…œ í˜¸ì¶œ ìš”ì²­(ì—¬ê¸°ì„œëŠ” ì»¤ë„ì´ OpenSBIì—ê²Œ ì‹œìŠ¤í…œì½œ ìš”ì²­)

ğŸ‘‰Â ì¶œë ¥ ì˜¤í¼ëœë“œ `=r(a0), =r(a1)`

- SBI ì‘ë‹µ ê²°ê³¼

ğŸ‘‰Â `return (struct sbiret){.error = a0, .value = a1};`

- í˜¸ì¶œ ê²°ê³¼ë¥¼ êµ¬ì¡°ì²´(`sbiret`)ë¡œ ë°˜í™˜

## ğŸ“ŒÂ `putchar`

âœ…Â ë¬¸ì ì¶œë ¥ í•¨ìˆ˜

- OpenSBIì˜ ì½˜ì†” ì¶œë ¥ ê¸°ëŠ¥ì„ ì‹œìŠ¤í…œì½œë¡œ ìš”ì²­í•˜ëŠ” í•¨ìˆ˜
- ì´ í•¨ìˆ˜ì˜ ë²ˆí˜¸ëŠ” `eid =1, fid =0`
- í•¨ìˆ˜ì˜ ê·œì¹™ : ë¬¸ì í•˜ë‚˜ë¥¼ `a0`ì— ë„£ê³  `a1`-`a5`ëŠ” `0`ìœ¼ë¡œ ì„¸íŒ…
- ì´ í•¨ìˆ˜ëŠ” ì¶œë ¥ ì „ìš© â†’ âˆ´ `sbiret`ì´ ì—†ìŒ â†’ âˆ´ `void`

```c
void putchar(char ch) {
    sbi_call(ch, 0, 0, 0, 0, 0, 0, 1);  // fid=0, eid=1: Console Putchar
}
```

## ğŸ“ŒÂ `kernel_main()`

ğŸ‘‰Â ë¬¸ìì—´ ì¶œë ¥

- ë¬¸ìì—´ì„ `putchar()` í•¨ìˆ˜ë¡œ í•œ ê¸€ìì”© ì¶œë ¥

ğŸ‘‰Â `__asm__ __volatile__("wfi");`

- ë¬´í•œ ë£¨í”„ ë¸”ë¡ì˜ ì½”ë“œ
- `wfi` : Wait For Interrupt â†’ CPUë¥¼ ì €ì „ë ¥ ìƒíƒœë¡œ ì „í™˜
- ì—¬ê¸°ì„œëŠ” ì»¤ë„ ì¢…ë£Œ ë°©ì§€ ìš©ë„

## ğŸ“ŒÂ **íŠ¸ë© í•¸ë“¤ëŸ¬ (Trap Handler)**

âœ…Â ê°œë…

- ì˜ˆì™¸(Exception)ë‚˜ ì‹œìŠ¤í…œì½œì´ ë°œìƒí–ˆì„ ë•Œ CPUê°€ ìë™ìœ¼ë¡œ í˜¸ì¶œí•˜ëŠ” íŠ¹ì • í•¨ìˆ˜
- ì¦‰, ì˜ˆì™¸ ìƒí™©ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ì•™ í•¨ìˆ˜

âœ…Â ì˜ˆì‹œ

- OpenSBIì˜ `sbi_trap_handler()` í•¨ìˆ˜ëŠ” ì»¤ë„ì—ì„œ `ecall` ëª…ë ¹ì„ ì‹¤í–‰í–ˆì„ ë•Œ í˜¸ì¶œë¨
- ì—¬ê¸°ì„œ ì–´ë–¤ SBI ê¸°ëŠ¥ì¸ì§€ íŒë‹¨í•˜ê³ , ì•Œë§ì€ ì²˜ë¦¬ í•¨ìˆ˜ë¡œ ì—°ê²°

## ğŸ“ŒÂ **`mtvec` ë ˆì§€ìŠ¤í„° (Machine Trap-Vector Register)**

âœ…Â ê°œë…

- `mtvec` ë ˆì§€ìŠ¤í„° (Machine Trap-Vector Register)
- RISC-Vì—ì„œ íŠ¸ë©(ì˜ˆì™¸, ì¸í„°ëŸ½íŠ¸)ì´ ë°œìƒí–ˆì„ ë•Œ ì í”„í•  ì£¼ì†Œë¥¼ ì €ì¥í•˜ëŠ” ë ˆì§€ìŠ¤í„°
- M modeì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•œ ë ˆì§€ìŠ¤í„°

âœ…Â ì˜ˆì‹œ

- OpenSBIëŠ” ë¶€íŒ… ì‹œ `mtvec`ì— íŠ¸ë© í•¸ë“¤ëŸ¬ ì£¼ì†Œë¥¼ ë“±ë¡
- ì´í›„ ì»¤ë„ì—ì„œ `ecall`ì´ ì‹¤í–‰ë˜ë©´ â†’ CPUëŠ” `mtvec`ì´ ê°€ë¦¬í‚¤ëŠ” M-mode ì½”ë“œë¡œ ì í”„

## ğŸ“ŒÂ **UART ë“œë¼ì´ë²„**

âœ…Â ê°œë…

- UART HW ì¥ì¹˜(ì‹œë¦¬ì–¼ í†µì‹ ìš© ì¹©)ì„ ì œì–´í•˜ê¸° ìœ„í•œ SW
- íŠ¹ì • ì£¼ì†Œë¡œ ë°ì´í„°ë¥¼ ì“°ë©´ ë¬¸ì 1ê°œê°€ ì „ì†¡ë¨

âœ…Â ì˜ˆì‹œ

- OpenSBIì˜ `uart8250_putchar()` í•¨ìˆ˜ëŠ” UART ë ˆì§€ìŠ¤í„°ì— 1ë°”ì´íŠ¸ ë°ì´í„°ë¥¼ ì¨ì„œ ë¬¸ì ì¶œë ¥

## ğŸ“ŒÂ **UART8250 ì—ë®¬ë ˆì´ì…˜ ì¥ì¹˜**

âœ…Â ê°œë…

- QEMUê°€ ì œê³µí•˜ëŠ” ê°€ìƒì˜ UART í•˜ë“œì›¨ì–´ ì¥ì¹˜
- ì‹¤ì œ UART ì¹©(8250 ëª¨ë¸)ì„ ì†Œí”„íŠ¸ì›¨ì–´ë¡œ êµ¬í˜„í•´ ì‹œë¦¬ì–¼ ì…ì¶œë ¥ì„ í‰ë‚´ëƒ„

âœ…Â ì˜ˆì‹œ

- ì»¤ë„ì´ `sbi_console_putchar()`ë¥¼ í˜¸ì¶œí•˜ë©´
- â†’ OpenSBIê°€ UART8250 ì¥ì¹˜ë¥¼ í†µí•´ QEMUë¡œ ë¬¸ì 1ê°œ ì „ì†¡
- â†’ í„°ë¯¸ë„ì— ì¶œë ¥ë¨

## ğŸ“ŒÂ `printf()`

âœ…Â ì „ì²´ íë¦„ ìš”ì•½

1. í¬ë§· ë¬¸ìì—´(fmt)ì„ í•œ ê¸€ìì”© ì½ìŒ

2. `%` ë¬¸ìê°€ ë‚˜ì˜¤ë©´ â†’ ë‹¤ìŒ ë¬¸ìë¡œ í¬ë§· ì¢…ë¥˜(`s,d,x`) íŒë‹¨

3. í¬ë§· ì¢…ë¥˜ì— ë”°ë¼ `va_arg`ë¡œ ì¸ì ì¶”ì¶œ í›„ ì¶œë ¥

4. ì¼ë°˜ ë¬¸ìë©´ ê·¸ëŒ€ë¡œ ì¶œë ¥

5. ëª¨ë“  ë¬¸ì ì¶œë ¥ ì™„ë£Œ í›„ `va_end`ë¡œ ì¢…ë£Œ

ğŸ‘‰Â ì˜ˆì‹œ : í¬ë§· ë¬¸ìì—´ê³¼ ê°€ë³€ ì¸ì

```c
printf("1 + %d = %d", 2, 3);
```

- í¬ë§· ë¬¸ìì—´ : `"1 + %d = %d"`
- ê°€ë³€ ì¸ì : `2, 3`

ğŸ‘‰Â Â `va_list`, `va_start`, `va_arg`, `va_end`

- ê°€ë³€ ì¸ì(variadic arguments)ë¥¼ ì²˜ë¦¬í•˜ëŠ” C ë§¤í¬ë¡œë“¤

âœ…Â ì½”ë“œ ìƒì„¸ ì„¤ëª…

```c
#include "common.h"

void putchar(char ch);
```

ğŸ‘‰Â `putchar` : ë¬¸ì ì¶œë ¥ìš© í•¨ìˆ˜

---

```c
void printf(const char *fmt, ...) {
    va_list vargs;
    va_start(vargs, fmt);
```

ğŸ‘‰Â `*fmt`

- í¬ë§· ë¬¸ìì—´
- ì˜ˆë¥¼ ë“¤ë©´, `printf(â€1 + %d = %dâ€, 2, 3);` ì—ì„œ `â€1 + %d = %dâ€` ê°€ `fmt`

ğŸ‘‰Â `...` (ì„¸ ê°œì˜ ì )

- ê°€ë³€ ì¸ì
- ì¦‰, í¬ë§· ë¬¸ìì—´ ë’¤ì— ëª‡ ê°œì˜ ì¸ìê°€ ì™€ë„ ìƒê´€ ì—†ìŒ

ğŸ‘‰Â  `va_list vargs;`

- ê°€ë³€ ì¸ìì— ì ‘ê·¼í•˜ë ¤ë©´ ë„êµ¬ê°€ í•„ìš”í•¨
- `va_list`ëŠ” ê°€ë³€ ì¸ìë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ í¬ì¸í„° íƒ€ì… ê°™ì€ ë³€ìˆ˜

ğŸ‘‰Â `va_start(vargs, fmt);`

- ì´ í•¨ìˆ˜ëŠ” `vargs`ë¥¼ `fmt` ë‹¤ìŒì— ì˜¤ëŠ” ê°€ë³€ ì¸ìë“¤ì˜ ì‹œì‘ì ìœ¼ë¡œ ì´ˆê¸°í™”
- ì´ë ‡ê²Œ í•˜ë©´, `vargs`ë¥¼ í†µí•´ `fmt` ë’¤ì— ì˜¤ëŠ” `2`, `3` ë“±ì„ êº¼ë‚´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ

---

```c
while (*fmt) {
    if (*fmt == '%') {
        fmt++; // '%'ì€ ê±´ë„ˆëœ€ -> fmtì—ëŠ” % ë’¤ì— ë‚˜ì˜¤ëŠ” ë¬¸ìê°€ ì°¸ì¡°ë¨
```

- í¬ë§· ë¬¸ìì—´ì„ í•œ ê¸€ìì”© ì½ìŒ
- `%`ê°€ ë‚˜ì˜¤ë©´ í¬ë§· ëª…ë ¹ ì²˜ë¦¬ ì‹œì‘

---

`âœ…Â %` ì´í›„ ë¬¸ìì— ë”°ë¼ ë™ì‘ ë¶„ê¸°

```c
        switch (*fmt) {
            case '\0':
                putchar('%');
                goto end;

```

- ë¬¸ìì—´ ëì— `%`ë§Œ ë©ê·¸ëŸ¬ë‹ˆ ìˆìœ¼ë©´ ê·¸ëƒ¥ `%` ì¶œë ¥

```c
            case '%':
                putchar('%');
                break;

```

- `%%`ëŠ” `%` í•˜ë‚˜ ì¶œë ¥

---

### `%s`: ë¬¸ìì—´ ì¶œë ¥

```c
            case 's': {
                const char *s = va_arg(vargs, const char *);
                while (*s) {
                    putchar(*s);
                    s++;
                }
                break;
            }
```

- ê°€ë³€ ì¸ìì—ì„œ ë¬¸ìì—´ í¬ì¸í„° ê°€ì ¸ì™€ í•œ ê¸€ìì”© ì¶œë ¥
- ë¬¸ìì—´ ëì— ë„ë‹¬í•˜ë©´(null ë¬¸ì, `\0`) whileë¬¸ ì¢…ë£Œ

---

### `%d`: 10ì§„ìˆ˜ ì •ìˆ˜ ì¶œë ¥

```c
            case 'd': {
		            // 1. ì¸ì êº¼ë‚´ê¸°
                int value = va_arg(vargs, int);

                // 2. ìŒìˆ˜ ì²˜ë¦¬
                unsigned magnitude = value;
                if (value < 0) {
                    putchar('-'); // - ì¶œë ¥
                    magnitude = -magnitude; // ìë¦¿ìˆ˜ ê³„ì‚°ì„ ìœ„í•´ ìŒìˆ˜ì˜ ì ˆëŒ“ê°’ í•„ìš”
                }

								// 3. ê°€ì¥ í° ìë¦¿ìˆ˜ ê³„ì‚°
                unsigned divisor = 1;
                while (magnitude / divisor > 9)
                    divisor *= 10;

								// 4. í•œ ìë¦¬ì”© ì¶œë ¥
                while (divisor > 0) {
                    putchar('0' + magnitude / divisor); // ìˆ«ìë¥¼ ë¬¸ìë¡œ ì¶œë ¥
                    magnitude %= divisor;
                    divisor /= 10;
                }

                break;
            }
```

### `%x`: 16ì§„ìˆ˜ ì •ìˆ˜ ì¶œë ¥

```c
            case 'x': {
                unsigned value = va_arg(vargs, unsigned);
                for (int i = 7; i >= 0; i--) {
                    unsigned nibble = (value >> (i * 4)) & 0xf;
                    putchar("0123456789abcdef"[nibble]);
                }
            }

```

### ì¼ë°˜ ë¬¸ì ì¶œë ¥

```c
    } else {
        putchar(*fmt);
    }
```

- `%`ê°€ ì•„ë‹Œ ì¼ë°˜ ë¬¸ìë©´ ê·¸ëŒ€ë¡œ ì¶œë ¥

---

### ì¢…ë£Œ ì²˜ë¦¬

```c
    fmt++;
}

end:
    va_end(vargs);
}

```

- ë‹¤ìŒ ë¬¸ìë¡œ ì´ë™
- ëë‚˜ë©´ `va_end`ë¡œ ê°€ë³€ ì¸ì ì¢…ë£Œ
